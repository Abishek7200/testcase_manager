<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Test Management - Module</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"> -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="./css/module.css">
  <style>
    /* --- Final Folder Tree CSS --- */
    /* --- Final and Corrected Folder Tree CSS --- */
    .folder-list ul {
      list-style-type: none;
      padding-left: 20px;
      margin-left: 7px;
      position: relative;
      /* Essential for positioning the connector lines */
    }

    /* This is the main vertical line for a list of sub-folders */
    .folder-list ul::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 1px;
      height: 100%;
      background-color: #c8c8c8;
    }

    .folder-item {
      margin: 0;
      padding: 2px 0;
    }

    /* This is the horizontal "T" line (├──) connecting each item to the vertical line */
    .folder-item::before {
      content: '';
      position: absolute;
      top: 20px;
      /* Adjust to align with the middle of the folder icon */
      left: -13px;
      /* Pulls it left to connect with the vertical line */
      width: 14px;
      height: 1px;
      background-color: #c8c8c8;
    }

    /* This creates the "L" shape (└──) for the LAST item in a list */
    .folder-item:last-child::before {
      height: 2px;
      /* Make it slightly thicker to look cleaner */
    }

    /* This pseudo-element "erases" the main vertical line below the last item */
    .folder-item:last-child::after {
      content: '';
      position: absolute;
      top: 21px;
      left: -21px;
      /* Position to cover the main vertical line */
      width: 1px;
      height: calc(100% - 20px);
      background-color: #fff;
      /* MUST match your sidebar background color */
    }

    /* --- General Folder Content Styling --- */
    .folder-content {
      display: flex;
      align-items: center;
      padding: 6px;
      border-radius: 5px;
      position: relative;
      cursor: pointer;
    }

    .folder-content.active {
      background-color: #e8e8fc;
    }

    .delete-folder-btn {
      margin-left: auto;
      /* Push to the far right */
      padding: 0 5px;
      display: block;
      /* Hide by default */
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .delete-folder-btn:hover {
      opacity: 1;
    }

    /* CSS for table action buttons */
    .column-actions button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      margin: 0 2px;
      opacity: 0.7;
      transition: opacity 0.2s, background-color 0.2s;
    }

    .column-actions button:hover {
      opacity: 1;
      background-color: #f0f0f0;
    }

    .column-actions .delete-test-btn:hover {
      background-color: #ffebee;
      /* Light red background on hover */
      color: #c62828;
      /* Darker red icon color on hover */
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Testcase Manager v1.1</h2>
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <div class="folder-search">
      <input type="search" id="folderSearch" placeholder="Search modules..." autocomplete="off">
    </div>
    <div class="accordion">
      <button class="accordion-header" id="toggleFolderFormBtn">
        <span>Add Module</span>
        <span class="accordion-icon">+</span>
      </button>
      <div class="accordion-content">
        <form id="createFolderForm">
          <div class="form-group">
            <label for="folderName">Module Name</label>
            <input type="text" id="folderName" name="folderName" placeholder="Enter module name" required>
          </div>
          <div class="form-group">
            <label for="parentFolder">Parent Module</label>
            <select id="parentFolder" name="parentId">
              <option value="">None (Top Level)</option>
            </select>
          </div>
          <button type="submit">Create Module</button>
        </form>
      </div>
    </div>

    <ul class="folder-list" id="folderList">
      <li class="folder-item active" id="allTestsItem">
        <div class="folder-content">
          <a href="#" data-folder-id="all">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>All Test Cases</span>
            <span class="folder-count" id="allTestsCount">(0)</span>
          </a>
        </div>
      </li>
      <!-- Folders will be dynamically inserted here -->
    </ul>
    <div class="sidebar-footer">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="controls-container">
      <h2 id="contentTitle">All Test Cases</h2>

      <!-- Report Visualization -->
      <div class="test-report">
        <div class="report-card total-tests">
          <span class="report-count" id="totalTestsCount">0</span>
          <span class="report-label">Total Tests</span>
        </div>
        <div class="report-card passed-tests">
          <span class="report-count" id="passedTestsCount">0</span>
          <span class="report-label">Passed</span>
        </div>
        <div class="report-card failed-tests">
          <span class="report-count" id="failedTestsCount">0</span>
          <span class="report-label">Failed</span>
        </div>
        <div class="report-card not-run-tests">
          <span class="report-count" id="notRunTestsCount">0</span>
          <span class="report-label">Not Run</span>
        </div>
        <div class="report-card blocked-tests">
          <span class="report-count" id="blockedTestsCount">0</span>
          <span class="report-label">Blocked</span>
        </div>
      </div>

      <div class="content-header">
        <!-- Search Bar -->
        <div class="search-container">
          <input type="search" id="searchInput" placeholder="Search by ID, Title, Ticket ID, or Tags..."
            autocomplete="off">
        </div>
        <div class="action-buttons">
          <button class="add-test-btn" id="addTestBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Test Case
          </button>
          <button class="add-test-btn" id="importBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Import Test Cases
          </button>
          <button class="add-test-btn" id="exportBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="17" x2="12" y2="11"></line>
              <polyline points="9 14 12 11 15 14"></polyline>
            </svg>
            Export to Excel
          </button>
          <button id="filterToggle" class="add-test-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path>
            </svg>
            Filters
          </button>
        </div>
      </div>

      <!-- Collapsible Filters Panel -->
      <div id="filtersPanel" class="filters-panel">
        <div class="filter-row">
          <div class="filter-group">
            <label>Status</label>
            <div class="filter-options">
              <label class="filter-checkbox">
                <input type="checkbox" value="Not Run" checked> Not Run
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" value="Pass" checked> Pass
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" value="Fail" checked> Fail
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" value="Blocked" checked> Blocked
              </label>
            </div>
          </div>

          <div class="filter-group">
            <label>Created By</label>
            <select id="createdByFilter" class="compact-select">
              <option value="">All Users</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Date Range</label>
            <select id="dateFilter" class="compact-select">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Folder</label>
            <select id="folderFilter" class="compact-select">
              <option value="">All Folders</option>
            </select>
          </div>

          <button id="aplyFilters" class="primary-btn">Apply</button>
          <button id="resetFilters" class="secondary-btn">Reset</button>
        </div>
      </div>

      <div style="display: contents;position: relative;justify-self: right;left: 55%;">
        <div class="column-visibility">
          <button class="column-visibility-btn add-test-btn" id="columnVisibilityBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Columns
          </button>
          <div class="column-visibility-menu" id="columnVisibilityMenu" style="display: none; gap: 30px;">
            <label><input type="checkbox" name="visibleColumns" value="id" checked> ID</label>
            <label><input type="checkbox" name="visibleColumns" value="title" checked> Title</label>
            <label><input type="checkbox" name="visibleColumns" value="ticketId" checked> Ticket id</label>
            <label><input type="checkbox" name="visibleColumns" value="tags" checked> Tags</label>
            <label><input type="checkbox" name="visibleColumns" value="preConditions"> Pre-conditions</label>
            <label><input type="checkbox" name="visibleColumns" value="steps" checked> Steps</label>
            <label><input type="checkbox" name="visibleColumns" value="testData" checked> Test Data</label>
            <label><input type="checkbox" name="visibleColumns" value="expected" checked> Expected</label>
            <label><input type="checkbox" name="visibleColumns" value="actualOutput"> Actual</label>
            <label><input type="checkbox" name="visibleColumns" value="status" checked> Status</label>
            <label><input type="checkbox" name="visibleColumns" value="createdOn"> Created On</label>
            <label><input type="checkbox" name="visibleColumns" value="createdBy"> Created By</label>
            <label><input type="checkbox" name="visibleColumns" value="folder"> Module</label>
            <label><input type="checkbox" name="visibleColumns" value="actions" checked> Actions</label>
          </div>
          <button id="copySelectedBtn" class="column-visibility-btn copy-selected-btn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy Selected
          </button>
          <button id="deleteSelectedBtn" class="column-visibility-btn delete-selected-btn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete Selected
          </button>
          <button id="bulkEditBtn" class="column-visibility-btn" disabled>Bulk Edit</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllTests"></th>
            <th class="column-id">ID</th>
            <th class="column-title">Title</th>
            <th class="column-ticketId">Ticket id</th>
            <th class="column-tags">Tags</th>
            <th class="column-preConditions">Pre-conditions</th>
            <th class="column-steps">Steps</th>
            <th class="column-testData">Test Data</th>
            <th class="column-expected">Expected</th>
            <th class="column-actualOutput">Actual</th>
            <th class="column-status">Status</th>
            <th class="column-createdOn hidden-column">Created On</th>
            <th class="column-createdBy hidden-column">Created By</th>
            <th class="column-folder">Module</th>
            <th class="column-actions">Actions</th>
          </tr>
        </thead>
        <tbody id="tests">
        </tbody>
      </table>

      <div class="pagination" id="pagination">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPage" disabled>Next</button>
      </div>
    </div>

    <div id="importModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h3>Import Test Cases</h3>
          <button class="modal-close" id="closeImportModal">&times;</button>
        </div>
        <div class="form-group">
          <label for="excelData">Paste Excel Data Here:</label>
          <textarea id="excelData" rows="10" style="width: 100%; font-family: monospace;"
            placeholder="Paste your Excel data with column names as below 
(Title, Ticket ID, Tags, Module, Pre-conditions, Steps, Test Data, Expected Behaviour, Actual Output, Status)"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="secondary" id="cancelImport">Cancel</button>
          <button type="button" id="confirmImport">Import Test Cases</button>
        </div>
      </div>
    </div>

    <div id="addTestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Test Case</h3>
          <button class="modal-close" id="closeAddModal">&times;</button>
        </div>
        <form id="testCaseForm">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" placeholder="Enter test case title" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="ticketId">Ticket ID</label>
              <input type="text" id="ticketId" name="ticketId" placeholder="e.g., PROJ-123">
            </div>

            <div class="form-group">
              <label for="folderId">Module</label>
              <select id="folderDropdown" name="folderId" required>
                <option value="" disabled selected>Select a module</option>
              </select>
            </div>

            <div class="form-group">
              <label for="tags">Tags (comma-separated)</label>
              <input type="text" id="tags" name="tags" placeholder="e.g., smoke, p1">
            </div>
          </div>

          <div class="form-group form-toggle">
            <label for="toggleTestData" class="toggle-label">Include Test Data?</label>
            <label class="switch">
              <input type="checkbox" id="toggleTestData">
              <span class="slider round"></span>
            </label>
          </div>
          
          <div class="form-row-editors">
            
            <div class="form-group editor-group">
              <label for="preConditions">Pre-conditions</label>
              <div id="preConditionsEditor" style="height: 200px;"></div>
              <textarea id="preConditions" name="preConditions" style="display:none;"></textarea>
            </div>
          
            <div class="form-group editor-group">
              <label for="steps">Steps</label>
              <div id="stepsEditor" style="height: 200px;"></div>
              <textarea id="steps" name="steps" style="display:none;"></textarea>
            </div>
          
            <div class="form-group editor-group" id="testDataGroup" style="display: none;">
              <label for="testData">Test Data</label>
              <div id="testDataEditor" style="height: 200px;"></div>
              <textarea id="testData" name="testData" style="display:none;"></textarea>
            </div>
          
          </div>

          <div class="form-row-editors">
          <div class="form-group editor-group">
            <label for="expected">Expected Behaviour</label>
            <div id="expectedEditor" style="height: 150px;"></div>
            <textarea id="expected" name="expected" style="display:none;"></textarea>
          </div>

          <div class="form-group editor-group">
            <label for="actualOutput">Actual Output</label>
            <div id="actualOutputEditor" style="height: 150px;"></div>
            <textarea id="actualOutput" name="actualOutput" style="display:none;"></textarea>
          </div>
        </div>

          <div class="modal-footer">
            <button type="button" class="secondary" id="cancelAddTest">Cancel</button>
            <button type="submit" id="submitTestForm">Add Test Case</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Test Case</h3>
          <button class="modal-close" id="closeEditModal">&times;</button>
        </div>
        <form id="editTestCaseForm">
          <input type="hidden" id="editTestId" name="id">

          <div class="form-group">
            <label for="editTitle">Title</label>
            <input type="text" id="editTitle" name="title" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="editTicketId">Ticket ID</label>
              <input type="text" id="editTicketId" name="ticketId" placeholder="e.g., PROJ-123">
            </div>

            <div class="form-group">
              <label for="editFolderId">Module</label>
              <select id="editFolderDropdown" name="folderId" required></select>
            </div>

            <div class="form-group">
              <label for="editTags">Tags (comma-separated)</label>
              <input type="text" id="editTags" name="tags" placeholder="e.g., smoke, regression, p1">
            </div>
          </div>

          <div class="form-group form-toggle">
            <label for="toggleEditTestData" class="toggle-label">Include Test Data?</label>
            <label class="switch">
              <input type="checkbox" id="toggleEditTestData">
              <span class="slider round"></span>
            </label>
          </div>

          <div class="form-row-editors">
            <div class="form-group editor-group">
            <label for="editPreConditions">Pre-conditions</label>
            <div id="editPreConditionsEditor"></div>
            <textarea id="editPreConditions" name="preConditions" style="display:none;"></textarea>
          </div>

          <div class="form-group editor-group">
            <label for="editSteps">Steps</label>
            <div id="editStepsEditor" style="height: 200px;"></div>
            <textarea id="editSteps" name="steps" style="display:none;"></textarea>
          </div>

          <div class="form-row-editors">
            <div class="form-group editor-group" id="editTestDataGroup" style="display: none;">
              <label for="editTestData">Test Data</label>
              <div id="editTestDataEditor" style="height: 200px;"></div>
              <textarea id="editTestData" name="testData" style="display:none;"></textarea>
            </div>
          </div>
        </div>

        <div class="form-row-editors">
          <div class="form-group editor-group">
            <label for="editExpected">Expected Behaviour</label>
            <div id="editExpectedEditor" style="height: 150px;"></div>
            <textarea id="editExpected" name="expected" style="display:none;"></textarea>
          </div>

          <div class="form-group editor-group">
            <label for="editActualOutput">Actual Output</label>
            <div id="editActualOutputEditor" style="height: 150px;"></div>
            <textarea id="editActualOutput" name="actualOutput" style="display:none;"></textarea>
          </div>
        </div>

          <div class="modal-footer">
            <button type="button" class="secondary" id="cancelEditTest">Cancel</button>
            <button type="submit" id="submitEditTest">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <div id="bulkEditModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>Bulk Edit Selected Test Cases</h3>
              <button class="modal-close" id="closeBulkEditModal">&times;</button>
          </div>
          <form id="bulkEditForm">
              <p>Select a field, enter a new value, and it will be applied to all selected test cases.</p>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_folderId" class="bulk-edit-toggle">
                  <label for="bulkEditFolder">Module</label>
                  <select id="bulkEditFolder" name="folderId" disabled></select>
              </div>
  
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_status" class="bulk-edit-toggle">
                  <label for="bulkEditStatus">Status</label>
                  <select id="bulkEditStatus" name="status" disabled>
                      <option value="Not Run">Not Run</option>
                      <option value="Pass">Pass</option>
                      <option value="Fail">Fail</option>
                      <option value="Blocked">Blocked</option>
                  </select>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_tags" class="bulk-edit-toggle">
                  <label for="bulkEditTags">Tags</label>
                  <input type="text" id="bulkEditTags" name="tags" placeholder="e.g., smoke, regression" disabled>
              </div>
  
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_ticketId" class="bulk-edit-toggle">
                  <label for="bulkEditTicketId">Ticket ID</label>
                  <input type="text" id="bulkEditTicketId" name="ticketId" placeholder="e.g., PROJ-123" disabled>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_preConditions" class="bulk-edit-toggle">
                  <label for="bulkEditPreConditions">Pre-conditions</label>
                  <textarea id="bulkEditPreConditions" name="preConditions" rows="3" disabled></textarea>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_steps" class="bulk-edit-toggle">
                  <label for="bulkEditSteps">Steps</label>
                  <textarea id="bulkEditSteps" name="steps" rows="3" disabled></textarea>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_testData" class="bulk-edit-toggle">
                  <label for="bulkEditTestData">Test Data</label>
                  <textarea id="bulkEditTestData" name="testData" rows="3" disabled></textarea>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_expected" class="bulk-edit-toggle">
                  <label for="bulkEditExpected">Expected</label>
                  <textarea id="bulkEditExpected" name="expected" rows="3" disabled></textarea>
              </div>
              
              <div class="bulk-edit-row">
                  <input type="checkbox" id="editField_actualOutput" class="bulk-edit-toggle">
                  <label for="bulkEditActualOutput">Actual</label>
                  <textarea id="bulkEditActualOutput" name="actualOutput" rows="3" disabled></textarea>
              </div>
  
              <div class="modal-footer">
                  <button type="button" class="secondary" id="cancelBulkEdit">Cancel</button>
                  <button type="submit" id="submitBulkEdit">Apply Changes</button>
              </div>
          </form>
      </div>
  </div>

    <!-- <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-xlsx@0.0.8/dist/html-to-xlsx.min.js"></script>
    <script>
      // --- CONSTANTS & DOM ELEMENTS ---
      const TESTS_PER_PAGE = 15;
      const folderList = document.getElementById('folderList');
      const folderDropdown = document.getElementById('folderDropdown');
      const parentFolderDropdown = document.getElementById('parentFolder');
      const editFolderDropdown = document.getElementById('editFolderDropdown');
      const testTableBody = document.getElementById('tests');
      const addTestModal = document.getElementById('addTestModal');
      const editModal = document.getElementById('editModal');
      const contentTitle = document.getElementById('contentTitle');
      const searchInput = document.getElementById('searchInput');
      const filterToggle = document.getElementById('filterToggle');
      const pageInfo = document.getElementById('pageInfo');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const selectAllTestsCheckbox = document.getElementById('selectAllTests');
      const copySelectedBtn = document.getElementById('copySelectedBtn');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

      // --- STATE VARIABLES ---
      let username = localStorage.getItem('username');
      let currentFolderId = 'all';
      let currentPage = 1;
      let allTestsData = [];
      let filteredTests = [];
      let allFolders = [];
      let quillInstances = {};
      let selectedTests = new Set();
      let currentFilters = {
        search: '',
        status: [],
        createdBy: '',
        folder: ''
      };

      // --- INITIALIZATION ---
      document.addEventListener('DOMContentLoaded', initializeApp);

      async function initializeApp() {
        if (!await checkAuthentication()) {
          window.location.href = '/login';
          return;
        }
        initializeAllQuillEditors();
        setupEventListeners();
        setupFolderSearch();
        document.getElementById('resetFilters')?.click();

        await Promise.all([
          fetchFolders(),
          fetchTests()
        ]);

        populateFilterOptions();

        // Apply default hidden column styles
        document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
          if (!cb.checked) {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => el.classList.add('hidden-column'));
          }
        });

        document.getElementById('contentTitle').textContent = `All Test Cases (${allTestsData.length})`;
      }

      // --- QUILL EDITOR MANAGEMENT ---
      function initializeAllQuillEditors() {
        const editorConfig = {
          theme: 'snow',
          modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['clean']] }
        };
        const editors = {
          steps: '#stepsEditor', preConditions: '#preConditionsEditor', testData: '#testDataEditor', expected: '#expectedEditor', actualOutput: '#actualOutputEditor',
          editSteps: '#editStepsEditor', editPreConditions: '#editPreConditionsEditor', editTestData: '#editTestDataEditor', editExpected: '#editExpectedEditor', editActualOutput: '#editActualOutputEditor'
        };
        for (const [key, selector] of Object.entries(editors)) {
          quillInstances[key] = new Quill(selector, editorConfig);
        }
      }

      // --- FOLDER MANAGEMENT ---
      async function fetchFolders() {
        try {
          const response = await fetch('/api/folders');
          if (!response.ok) throw new Error('Failed to fetch folders');
          allFolders = await response.json();
          renderFolders();
          updateFolderDropdowns();
        } catch (error) {
          showToast(error.message, 'error');
        }
      }

      function renderFolders() {
        const folderContainer = document.getElementById('folderList');
        while (folderContainer.children.length > 1) {
          folderContainer.removeChild(folderContainer.lastChild);
        }

        // Create a map and build the tree structure
        const folderMap = new Map(allFolders.map(f => [f.id, { ...f, children: [] }]));
        const tree = [];

        folderMap.forEach(folder => {
          if (folder.parentId && folderMap.has(folder.parentId)) {
            // This is a sub-folder
            folderMap.get(folder.parentId).children.push(folder);
          } else {
            // This is a top-level folder
            tree.push(folder);
          }
        });

        // Render the tree starting from top-level folders
        tree.forEach(folder => {
          folderContainer.appendChild(createFolderNode(folder));
        });
      }

      function createFolderNode(folder) {
        const li = document.createElement('li');
        li.className = 'folder-item';
        li.dataset.folderId = folder.id;

        const hasChildren = folder.children && folder.children.length > 0;
        const expanderIcon = hasChildren ? '▼' : '';

        // This div holds the content for the CURRENT folder (e.g., "PDF")
        const contentDiv = document.createElement('div');
        contentDiv.className = `folder-content ${currentFolderId == folder.id ? 'active' : ''}`;
        contentDiv.innerHTML = `
        <span class="folder-expander">${expanderIcon}</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2z"></path></svg>
        <span class="folder-name">${escapeHtml(folder.name)}</span>
        <span class="folder-count">(${folder.testCaseCount || 0})</span>
        <span class="delete-folder-btn" title="Delete Folder"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="15" height="15" viewBox="0 0 48 48">
<path d="M 20.5 4 A 1.50015 1.50015 0 0 0 19.066406 6 L 14.640625 6 C 12.803372 6 11.082924 6.9194511 10.064453 8.4492188 L 7.6972656 12 L 7.5 12 A 1.50015 1.50015 0 1 0 7.5 15 L 8.2636719 15 A 1.50015 1.50015 0 0 0 8.6523438 15.007812 L 11.125 38.085938 C 11.423352 40.868277 13.795836 43 16.59375 43 L 31.404297 43 C 34.202211 43 36.574695 40.868277 36.873047 38.085938 L 39.347656 15.007812 A 1.50015 1.50015 0 0 0 39.728516 15 L 40.5 15 A 1.50015 1.50015 0 1 0 40.5 12 L 40.302734 12 L 37.935547 8.4492188 C 36.916254 6.9202798 35.196001 6 33.359375 6 L 28.933594 6 A 1.50015 1.50015 0 0 0 27.5 4 L 20.5 4 z M 14.640625 9 L 33.359375 9 C 34.196749 9 34.974746 9.4162203 35.439453 10.113281 L 36.697266 12 L 11.302734 12 L 12.560547 10.113281 A 1.50015 1.50015 0 0 0 12.5625 10.111328 C 13.025982 9.4151428 13.801878 9 14.640625 9 z M 11.669922 15 L 36.330078 15 L 33.890625 37.765625 C 33.752977 39.049286 32.694383 40 31.404297 40 L 16.59375 40 C 15.303664 40 14.247023 39.049286 14.109375 37.765625 L 11.669922 15 z"></path>
</svg></i></span>
    `;
        li.appendChild(contentDiv);

        // If this folder has children, create a NEW <ul> for them
        // This <ul> is a sibling to the contentDiv above, both inside the same <li>
        if (hasChildren) {
          const ul = document.createElement('ul');
          ul.className = 'folder-hierarchy'; // Expanded by default
          folder.children.forEach(child => ul.appendChild(createFolderNode(child)));
          li.appendChild(ul);

          const expander = contentDiv.querySelector('.folder-expander');
          expander.addEventListener('click', e => {
            e.stopPropagation();
            ul.classList.toggle('collapsed');
            expander.textContent = ul.classList.contains('collapsed') ? '▶' : '▼';
          });
        }

        // Add event listeners for this folder's contentDiv
        contentDiv.addEventListener('click', (e) => {
          if (e.target.closest('.folder-expander, .delete-folder-btn')) return;
          filterTestsByFolder(folder.id, folder.name);
        });

        contentDiv.querySelector('.delete-folder-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteFolder(folder.id);
        });

        return li;
      }

      function updateFolderDropdowns() {
        const dropdowns = [parentFolderDropdown, folderDropdown, editFolderDropdown];
        dropdowns.forEach(dd => {
          const firstOption = dd.options[0];
          dd.innerHTML = '';
          if (firstOption) dd.appendChild(firstOption);
        });

        const folderMap = new Map(allFolders.map(f => [f.id, { ...f, children: [] }]));
        const tree = [];
        allFolders.forEach(f => {
          if (f.parentId && folderMap.has(f.parentId)) folderMap.get(f.parentId).children.push(folderMap.get(f.id));
          else if (!f.parentId) tree.push(folderMap.get(f.id));
        });

        const buildDropdown = (folders, depth) => {
          folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.id;
            option.textContent = `${'  '.repeat(depth)}↳ ${escapeHtml(folder.name)}`;
            dropdowns.forEach(dd => dd.add(option.cloneNode(true)));
            if (folder.children.length > 0) buildDropdown(folder.children, depth + 1);
          });
        };
        tree.forEach(folder => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.textContent = escapeHtml(folder.name);
          dropdowns.forEach(dd => dd.add(option.cloneNode(true)));
          if (folder.children.length > 0) buildDropdown(folder.children, 1);
        });
      }

      async function handleCreateFolder(e) {
        e.preventDefault();
        const form = e.target;
        const folderName = form.folderName.value.trim();
        const parentId = form.parentId.value || null;

        if (!folderName) {
          showToast('Folder name is required', 'error');
          return;
        }

        try {
          const res = await fetch('/api/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: folderName, parentId })
          });
          if (!res.ok) throw new Error('Failed to create folder');

          form.reset();
          await fetchFolders(); // Refreshes the entire tree
          showToast('Folder created successfully', 'success');
        } catch (error) {
          showToast(error.message, 'error');
        }
      }
      async function deleteFolder(id) {
        if (!confirm('Are you sure you want to delete this folder and all its test cases? This action cannot be undone.')) return;

        try {
          showLoading(true);

          const res = await fetch(`/api/folders/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || 'Failed to delete folder');
          }

          currentFolderId = 'all';
          await fetchFolders();
          showToast('Folder and its test cases deleted successfully', 'success');

        } catch (error) {
          showToast(error.message, 'error');
        } finally {
          showLoading(false);
        }
      }

      // --- TEST CASE MANAGEMENT ---
      // In your <script> tag, replace the fetchTests function
      async function fetchTests() {
        try {
          showLoading(true);
          const url = `/api/tests${(currentFolderId && currentFolderId !== 'all') ? '?folderId=' + currentFolderId : ''}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to load tests');

          allTestsData = await response.json();

          // FIX: Update the "All Test Cases" count here
          const allTestsCountElement = document.getElementById('allTestsCount');
          if (allTestsCountElement) {
            // This count should reflect ALL tests in the database, not just the current view
            const allTestsResponse = await fetch('/api/tests');
            const allTests = await allTestsResponse.json();
            allTestsCountElement.textContent = allTests.length;
          }

          updateReport();
          applyFilters(); // This will filter the view and render the table
          // Add this block to set the initial column visibility
          document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => {
              el.classList.toggle('hidden-column', !cb.checked);
            });
          });

        } catch (error) {
          showToast(error.message, 'error');
        } finally {
          showLoading(false);
        }
      }

      function setupFolderSearch() {
        const folderSearch = document.getElementById('folderSearch');

        folderSearch.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const folderItems = document.querySelectorAll('.folder-item');

          folderItems.forEach(item => {
            const folderName = item.querySelector('span').textContent.toLowerCase();
            if (folderName.includes(searchTerm)) {
              item.style.display = '';
              // Ensure parent folders are visible
              let parent = item.parentElement.closest('.folder-item');
              while (parent) {
                parent.style.display = '';
                parent = parent.parentElement.closest('.folder-item');
              }
            } else {
              item.style.display = 'none';
            }
          });
        });
      }

      async function filterTestsByFolder(folderId, folderName) {
    currentFolderId = folderId;

    // Update the active state in the sidebar
    document.querySelectorAll('.folder-content.active').forEach(el => el.classList.remove('active'));
    const targetElement = folderId === 'all' 
        ? document.getElementById('allTestsItem') 
        : document.querySelector(`.folder-item[data-folder-id="${folderId}"]`);
    
    if (targetElement) {
        targetElement.querySelector('.folder-content').classList.add('active');
    }
    
    // Wait for the test data for this folder to be fetched
    await fetchTests(); 

    // Now that we have the data, get the count
    const count = allTestsData.length;
    const title = folderName ? folderName : 'All Test Cases';

    // Set the contentTitle with the name and the count
    contentTitle.textContent = `${title} (${count})`;
}

      function renderTests() {
        testTableBody.innerHTML = '';
        updatePaginationControls();
        const startIndex = (currentPage - 1) * TESTS_PER_PAGE;
        const testsForPage = filteredTests.slice(startIndex, startIndex + TESTS_PER_PAGE);

        if (testsForPage.length === 0) {
          testTableBody.innerHTML = `<tr><td colspan="14" class="empty-state">No test cases found.</td></tr>`;
          return;
        }
        testsForPage.forEach(test => testTableBody.appendChild(createTestRow(test)));
        setupRowEventHandlers();
        // autoShowColumnsWithData(testsForPage);
      }

      function createTestRow(test) {
        const row = document.createElement('tr');
        row.dataset.id = test.id;
        const createdDate = test.createdDate ? new Date(test.createdDate).toLocaleDateString() : 'N/A';
        row.innerHTML = `
            <td class="column-checkbox"><input type="checkbox" class="test-row-selector" data-test-id="${test.id}" ${selectedTests.has(String(test.id)) ? 'checked' : ''}></td>
            <td class="column-id">${test.testCaseId || 'N/A'}</td>
            <td class="column-title">${escapeHtml(test.title)}</td>
            <td class="column-ticketId">${escapeHtml(test.ticketId)}</td>
            <td class="column-tags">${escapeHtml(test.tags)}</td>
            <td class="column-preConditions">${test.preConditions || ''}</td>
            <td class="column-steps">${test.steps || ''}</td>
            <td class="column-testData">${test.testData || ''}</td>
            <td class="column-expected">${test.expected || ''}</td>
            <td class="column-actualOutput">${test.actualOutput || ''}</td>
            <td class="column-status">${createStatusDropdown(test)}</td>
            <td class="column-createdOn hidden-column">${createdDate}</td>
            <td class="column-createdBy hidden-column">${escapeHtml(test.createdBy)}</td>
            <td class="column-folder">${test.folder ? escapeHtml(test.folder.name) : 'Uncategorized'}</td>
            <td class="column-actions">
                <button class="edit-test-btn" title="Edit">✏️</button>
                <button class="delete-test-btn" title="Delete">🗑️</button>
            </td>`;
        return row;
      }

      // --- FORM & MODAL HANDLING ---
      function openAddTestModal() {
        document.getElementById('testCaseForm').reset();
        for (const key in quillInstances) {
          if (!key.startsWith('edit')) quillInstances[key].setContents([]);
        }
        addTestModal.style.display = 'flex';
        addTestModal.querySelector('.modal-content').scrollTop = 0;
      }

      async function handleAddTestCase(e) {
        e.preventDefault();
        const body = Object.fromEntries(new FormData(e.target).entries());
        body.preConditions = quillInstances.preConditions.root.innerHTML;
        body.steps = quillInstances.steps.root.innerHTML;
        body.testData = quillInstances.testData.root.innerHTML;
        body.expected = quillInstances.expected.root.innerHTML;
        body.actualOutput = quillInstances.actualOutput.root.innerHTML;
        body.createdBy = username;

        try {
          const res = await fetch('/api/tests', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!res.ok) throw new Error('Failed to create test case');
          closeModal();
          await Promise.all([fetchTests(), fetchFolders()]);
          showToast('Test case created!', 'success');
        } catch (error) { showToast(error.message, 'error'); }
      }

      function openEditModal(test) {
        const form = document.getElementById('editTestCaseForm');
        form.id.value = test.id;
        form.title.value = test.title;
        form.ticketId.value = test.ticketId || '';
        form.folderId.value = test.folder?.id || '';
        form.tags.value = test.tags || '';
        quillInstances.editPreConditions.root.innerHTML = test.preConditions || '';
        quillInstances.editSteps.root.innerHTML = test.steps || '';
        quillInstances.editTestData.root.innerHTML = test.testData || '';
        quillInstances.editExpected.root.innerHTML = test.expected || '';
        quillInstances.editActualOutput.root.innerHTML = test.actualOutput || '';

        // --- Logic for the Test Data toggle ---
    const editTestDataGroup = document.getElementById('editTestDataGroup');
    const toggle = document.getElementById('toggleEditTestData');
    
    // Check if the test case has any actual test data
    const hasTestData = test.testData && test.testData.trim() && test.testData.trim() !== '<p><br></p>';
    
    // Set the state of the toggle and the visibility of the field
    toggle.checked = hasTestData;
    editTestDataGroup.style.display = hasTestData ? 'flex' : 'none';

        editModal.style.display = 'flex';
        editModal.querySelector('.modal-content').scrollTop = 0;
      }

      async function handleEditTestCase(e) {
        e.preventDefault();
        const body = Object.fromEntries(new FormData(e.target).entries());
        body.preConditions = quillInstances.editPreConditions.root.innerHTML;
        body.steps = quillInstances.editSteps.root.innerHTML;
        body.testData = quillInstances.editTestData.root.innerHTML;
        body.expected = quillInstances.editExpected.root.innerHTML;
        body.actualOutput = quillInstances.editActualOutput.root.innerHTML;
        try {
          const res = await fetch('/api/tests', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!res.ok) throw new Error('Failed to update test case');
          closeModal();
          await fetchTests();
          showToast('Test case updated!', 'success');
        } catch (error) { showToast(error.message, 'error'); }
      }

      function closeModal() {
        addTestModal.style.display = 'none';
        editModal.style.display = 'none';
      }

      // Add this new function anywhere inside your <script> tag
      function populateFilterOptions() {
        const createdByFilter = document.getElementById('createdByFilter');
        const folderFilter = document.getElementById('folderFilter');

        // Populate "Created By" dropdown
        const users = [...new Set(allTestsData.map(test => test.createdBy).filter(Boolean))];
        createdByFilter.innerHTML = '<option value="">All Users</option>'; // Reset
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          createdByFilter.appendChild(option);
        });

        // Populate "Folder" dropdown
        folderFilter.innerHTML = '<option value="">All Folders</option>'; // Reset
        allFolders.forEach(folder => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.textContent = folder.name;
          folderFilter.appendChild(option);
        });
      }

      // --- SEARCH & FILTER ---
      function applyFilters() {
        // Get search term directly from the input field
        currentFilters.search = document.getElementById('searchInput').value.toLowerCase().trim();

        filteredTests = allTestsData.filter(test => {
          // Status filter
          if (currentFilters.status.length > 0 && !currentFilters.status.includes(test.testStatus)) {
            return false;
          }
          // Created By filter
          if (currentFilters.createdBy && test.createdBy !== currentFilters.createdBy) {
            return false;
          }
          // Folder filter
          if (currentFilters.folder && test.folder?.id != currentFilters.folder) {
            return false;
          }
          // Text search filter (ID, Title, Ticket ID, Tags)
          if (currentFilters.search) {
            const searchParts = currentFilters.search.split(',').map(s => s.trim()).filter(Boolean);
            const match = searchParts.some(part =>
              (test.testCaseId || '').toLowerCase().includes(part) ||
              (test.title || '').toLowerCase().includes(part) ||
              (test.ticketId || '').toLowerCase().includes(part) ||
              (test.tags || '').toLowerCase().split(',').map(t => t.trim()).includes(part)
            );
            if (!match) return false;
          }

          // If the test passed all filters, include it
          return true;
        });

        currentPage = 1;
        renderTests();
        updateReport(); // Update report metrics based on filtered data if desired
        // Add this block to set the initial column visibility
        document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => {
              el.classList.toggle('hidden-column', !cb.checked);
            });
          });
      }

      // --- PAGINATION ---
      function updatePaginationControls() {
        const totalPages = Math.ceil(filteredTests.length / TESTS_PER_PAGE);
        pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      }
      function goToPreviousPage() { if (currentPage > 1) { currentPage--; renderTests(); }
    // Add this block to set the initial column visibility
    document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => {
              el.classList.toggle('hidden-column', !cb.checked);
            });
          }); 
    }
      function goToNextPage() { if (currentPage < Math.ceil(filteredTests.length / TESTS_PER_PAGE)) { currentPage++; renderTests(); } 
      // Add this block to set the initial column visibility
      document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => {
              el.classList.toggle('hidden-column', !cb.checked);
            });
          });
    }

      // --- BULK ACTIONS & SELECTION ---
      function updateSelectedButtons() {
        const hasSelection = selectedTests.size > 0;
        copySelectedBtn.disabled = !hasSelection;
        deleteSelectedBtn.disabled = !hasSelection;
      }

      // Add this function to handle copying selected tests
      // Replace your copySelectedTests function
      function copySelectedTests() {
        if (selectedTests.size === 0) return;
        const selectedData = allTestsData.filter(test => selectedTests.has(String(test.id)));
        const headers = ['ID', 'Title', 'Tags', 'Pre-conditions', 'Steps', 'Test Data', 'Expected', 'Module'];
        const body = selectedData.map(test => [
          test.testCaseId, test.title, test.tags || '',
          htmlToPlainText(test.preConditions), htmlToPlainText(test.steps),
          htmlToPlainText(test.testData), htmlToPlainText(test.expected),
          test.folder ? test.folder.name : 'N/A'
        ].join('\t'));

        const tableContent = [headers.join('\t'), ...body].join('\n');
        navigator.clipboard.writeText(tableContent)
          .then(() => showToast(`${selectedData.length} test case(s) copied!`, 'success'))
          .catch(err => showToast('Failed to copy.', 'error'));
      }

      async function exportToExcel() {
        if (filteredTests.length === 0) {
          showToast('No test cases to export.', 'info');
          return;
        }
        const dataForExport = filteredTests.map(test => ({
          'Test Case ID': test.testCaseId || '',
          'Title': test.title,
          'Ticket ID': test.ticketId || '',
          'Tags': test.tags || '',
          'Module': test.folder ? test.folder.name : 'Uncategorized',
          'Pre-conditions': htmlToPlainText(test.preConditions),
          'Steps': htmlToPlainText(test.steps),
          'Test Data': htmlToPlainText(test.testData),
          'Expected Behaviour': htmlToPlainText(test.expected),
          'Actual Output': htmlToPlainText(test.actualOutput),
          'Status': test.testStatus || 'Not Run',
          'Created By': test.createdBy || '',
          'Created On': test.createdDate ? new Date(test.createdDate).toLocaleDateString() : ''
        }));

        const worksheet = XLSX.utils.json_to_sheet(dataForExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Test Cases");
        XLSX.writeFile(workbook, "Test_Cases_Export.xlsx");
        showToast('Exporting to Excel!', 'success');
      }

      // Helper function to convert Quill's HTML to plain text for copying
      // Add this helper function to your script
      function htmlToPlainText(html) {
        if (!html) return '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;

        // Handle line breaks
        tempDiv.querySelectorAll('p, div').forEach(el => {
          el.after(document.createTextNode('\n'));
        });
        tempDiv.querySelectorAll('br').forEach(br => {
          br.replaceWith(document.createTextNode('\n'));
        });

        // Handle lists
        tempDiv.querySelectorAll('li').forEach((li, index) => {
          const prefix = li.parentElement.tagName === 'OL' ? `${index + 1}. ` : '• ';
          li.prepend(document.createTextNode(prefix));
          li.after(document.createTextNode('\n'));
        });

        // Remove block elements after processing
        tempDiv.querySelectorAll('ol, ul, p, div').forEach(el => {
          el.replaceWith(...el.childNodes);
        });

        return tempDiv.textContent.trim().replace(/\n\s*\n/g, '\n'); // Clean up extra newlines
      }

      async function deleteSelectedTests() {
        if (selectedTests.size === 0 || !confirm(`Delete ${selectedTests.size} selected test cases?`)) return;
        try {
          const res = await fetch('/api/selectedtests/batch', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ testIds: Array.from(selectedTests) })
          });
          if (!res.ok) throw new Error('Batch delete failed');
          selectedTests.clear();
          selectAllTestsCheckbox.checked = false;
          await Promise.all([fetchTests(), fetchFolders()]);
          showToast('Selected tests deleted', 'success');
        } catch (error) { showToast(error.message, 'error'); }
      }

      // Add this new function anywhere in your script
      // Add this complete deleteTest function to your script
      async function deleteTest(testId) {
        if (!confirm('Are you sure you want to delete this test case?')) return;

        try {
          showLoading(true);
          const res = await fetch(`/api/tests/${testId}`, { method: 'DELETE' });
          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || 'Failed to delete test case');
          }

          showToast('Test case deleted.', 'success');

          // Refetch both tests and folders to ensure UI is fully updated
          await Promise.all([fetchTests(), fetchFolders()]);

        } catch (error) {
          showToast(error.message, 'error');
        } finally {
          showLoading(false);
        }
      }

      // Replace your setupRowEventHandlers function with this one
      function setupRowEventHandlers() {
        testTableBody.addEventListener('click', e => {
          const row = e.target.closest('tr');
          if (!row || !row.dataset.id) return;

          const testId = row.dataset.id;

          // FIX: Correctly finds the button via event delegation
          if (e.target.closest('.delete-test-btn')) {
            deleteTest(testId);
            return; // Stop further processing
          }

          if (e.target.closest('.edit-test-btn')) {
            const test = allTestsData.find(t => t.id == testId);
            if (test) openEditModal(test);
            return;
          }

          if (e.target.matches('.test-row-selector')) {
            if (e.target.checked) selectedTests.add(testId);
            else selectedTests.delete(testId);
            updateSelectedButtons();
          }
        });

        // Status dropdown change
        testTableBody.addEventListener('change', async e => {
          if (e.target.matches('.test-status-dropdown')) {
            const testId = e.target.dataset.testId;
            const newStatus = e.target.value;
            try {
              const res = await fetch(`/api/tests/${testId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ testStatus: newStatus })
              });
              if (!res.ok) throw new Error('Status update failed');

              // Update local data to reflect change immediately
              const testToUpdate = allTestsData.find(t => t.id == testId);
              if (testToUpdate) testToUpdate.testStatus = newStatus;

              showToast('Status updated', 'success');
            } catch (error) {
              showToast(error.message, 'error');
              // Revert dropdown on failure
              e.target.value = allTestsData.find(t => t.id == testId).testStatus;
            }
          }
        });
      }

      // Add this inside your setupEventListeners function
document.addEventListener('click', (e) => {
    const menu = document.getElementById('columnVisibilityMenu');
    const btn = document.getElementById('columnVisibilityBtn');

    // This condition checks two things:
    // 1. Was the click NOT inside the menu?
    // 2. Was the click NOT on the button that opens the menu?
    // The btn.contains() part is important in case the button has an icon inside it.
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
    }
});


      // --- EVENT LISTENERS ---
      function setupEventListeners() {
        // --- Sidebar and Logout (FIX) ---
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // --- Filters and Import Modals (FIX) ---
        document.getElementById('filterToggle').addEventListener('click', () => {
          document.getElementById('filtersPanel').classList.toggle('active');
        });
        document.getElementById('importBtn').addEventListener('click', openImportModal);
        document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
        document.getElementById('cancelImport').addEventListener('click', closeImportModal);
        document.getElementById('confirmImport').addEventListener('click', processImportedData);

        document.getElementById('bulkEditBtn').addEventListener('click', openBulkEditModal);
    document.getElementById('closeBulkEditModal').addEventListener('click', () => document.getElementById('bulkEditModal').style.display = 'none');
    document.getElementById('cancelBulkEdit').addEventListener('click', () => document.getElementById('bulkEditModal').style.display = 'none');
    document.getElementById('bulkEditForm').addEventListener('submit', handleBulkEdit);

    // Add listener to enable/disable inputs in the modal
    document.querySelectorAll('.bulk-edit-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            // Find the corresponding input/select element and enable/disable it
            e.target.nextElementSibling.nextElementSibling.disabled = !e.target.checked;
        });
    });

     // Toggle for the ADD modal
document.getElementById('toggleTestData').addEventListener('change', function() {
    const testDataGroup = document.getElementById('testDataGroup');
    testDataGroup.style.display = this.checked ? 'flex' : 'none';
});

// Toggle for the EDIT modal
document.getElementById('toggleEditTestData').addEventListener('change', function() {
    const editTestDataGroup = document.getElementById('editTestDataGroup');
    editTestDataGroup.style.display = this.checked ? 'flex' : 'none';
});

        // Add this inside your setupEventListeners function
document.getElementById('toggleFolderFormBtn').addEventListener('click', function() {
    this.classList.toggle('active');
    const icon = this.querySelector('.accordion-icon');
    const content = this.nextElementSibling;

    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        content.style.padding = "0 15px"; // Hide padding when collapsed
        icon.textContent = '+';
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        content.style.padding = "15px"; // Add padding when expanded
        icon.textContent = '−';
    }
});

        document.getElementById('aplyFilters').addEventListener('click', () => {
          // Gather all filter values and store them
          currentFilters.status = Array.from(document.querySelectorAll('#filtersPanel input[type="checkbox"]:checked')).map(cb => cb.value);
          currentFilters.createdBy = document.getElementById('createdByFilter').value;
          currentFilters.folder = document.getElementById('folderFilter').value;
          // Date range filter can be added here if needed

          applyFilters(); // Run the master filter function
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
          // Reset all filter UI elements
          document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => cb.checked = true);
          document.getElementById('createdByFilter').value = '';
          document.getElementById('folderFilter').value = '';
          document.getElementById('searchInput').value = '';

          // Reset the stored filter state
          currentFilters = { search: '', status: [], createdBy: '', folder: '' };

          applyFilters(); // Run the master filter function to show all results
        });

        // --- Existing Listeners ---
        document.getElementById('addTestBtn').addEventListener('click', openAddTestModal);
        document.getElementById('closeAddModal').addEventListener('click', closeModal);
        document.getElementById('cancelAddTest').addEventListener('click', closeModal);
        document.getElementById('closeEditModal').addEventListener('click', closeModal);
        document.getElementById('cancelEditTest').addEventListener('click', closeModal);

        document.getElementById('createFolderForm').addEventListener('submit', handleCreateFolder);
        document.getElementById('testCaseForm').addEventListener('submit', handleAddTestCase);
        document.getElementById('editTestCaseForm').addEventListener('submit', handleEditTestCase);

        document.getElementById('allTestsItem').addEventListener('click', () => filterTestsByFolder('all', 'All Test Cases'));
        searchInput.addEventListener('input', applyFilters);

        prevPageBtn.addEventListener('click', goToPreviousPage);
        nextPageBtn.addEventListener('click', goToNextPage);

        deleteSelectedBtn.addEventListener('click', deleteSelectedTests);
        copySelectedBtn.addEventListener('click', copySelectedTests);
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);

        // Column Visibility
        document.getElementById('columnVisibilityBtn').addEventListener('click', e => {
          e.stopPropagation();
          const menu = document.getElementById('columnVisibilityMenu');
          menu.style.display = menu.style.display === 'none' ? 'inline-table' : 'none';
        });
        document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', e => {
            document.querySelectorAll(`.column-${e.target.value}`).forEach(el => el.classList.toggle('hidden-column', !e.target.checked));
          });
        });

        // Row Selection
        selectAllTestsCheckbox.addEventListener('change', e => {
          const isChecked = e.target.checked;
          const testIdsOnPage = Array.from(document.querySelectorAll('.test-row-selector')).map(cb => cb.dataset.testId);

          testIdsOnPage.forEach(testId => {
            if (isChecked) selectedTests.add(testId);
            else selectedTests.delete(testId);
          });
          renderTests();
          updateSelectedButtons();
          // Add this block to set the initial column visibility
          document.querySelectorAll('#columnVisibilityMenu input[type="checkbox"]').forEach(cb => {
            const columnClass = `.column-${cb.value}`;
            document.querySelectorAll(columnClass).forEach(el => {
              el.classList.toggle('hidden-column', !cb.checked);
            });
          });
        });
      }

      // --- UTILITIES ---
      function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }
      function createStatusDropdown(test) {
        const statusOptions = ['Not Run', 'Pass', 'Fail', 'Blocked'];
        const statusColors = {
          'Not Run': 'blue',
          'Pass': 'green',
          'Fail': 'red',
          'Blocked': 'darkred'
        };

        const currentColor = statusColors[test.testStatus] || 'black';

        return `
    <select class="test-status-dropdown" data-test-id="${test.id}" style="color: ${currentColor}">
      ${statusOptions.map(option =>
          `<option value="${option}" ${test.testStatus === option ? 'selected' : ''}>${option}</option>`
        ).join('')}
    </select>
    `;
      }

      // This function was likely missing or incorrect in previous versions. Add or replace it.
      function updateReport() {
        const reportCards = {
          total: document.getElementById('totalTestsCount'),
          passed: document.getElementById('passedTestsCount'),
          failed: document.getElementById('failedTestsCount'),
          notRun: document.getElementById('notRunTestsCount'),
          blocked: document.getElementById('blockedTestsCount')
        };

        const counts = { passed: 0, failed: 0, notRun: 0, blocked: 0 };

        // FIX: Calculate counts from all tests in the folder, not the filtered list.
        allTestsData.forEach(test => {
          switch (test.testStatus) {
            case 'Pass': counts.passed++; break;
            case 'Fail': counts.failed++; break;
            case 'Blocked': counts.blocked++; break;
            default: counts.notRun++; break;
          }
        });

        // Update the text content of each report card
        reportCards.total.textContent = allTestsData.length;
        reportCards.passed.textContent = counts.passed;
        reportCards.failed.textContent = counts.failed;
        reportCards.notRun.textContent = counts.notRun;
        reportCards.blocked.textContent = counts.blocked;
      }

      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icons = {
          success: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>',
          error: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>',
          info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" /></svg>'
        };

        toast.innerHTML = `${icons[type] || icons.info} ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function showLoading(show) {
        const loadingOverlay = document.getElementById('loadingOverlay') || document.createElement('div');
        if (show) {
          loadingOverlay.id = 'loadingOverlay';
          loadingOverlay.style.position = 'fixed';
          loadingOverlay.style.top = '0';
          loadingOverlay.style.left = '0';
          loadingOverlay.style.width = '100%';
          loadingOverlay.style.height = '100%';
          loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
          loadingOverlay.style.display = 'flex';
          loadingOverlay.style.justifyContent = 'center';
          loadingOverlay.style.alignItems = 'center';
          loadingOverlay.style.zIndex = '9999';
          loadingOverlay.innerHTML = '<div class="spinner" style="width: 40px; height: 40px;"></div>';
          document.body.appendChild(loadingOverlay);
        } else {
          loadingOverlay.remove();
        }
      }

      // Authentication
      async function checkAuthentication() {
        try {
          const response = await fetch('/api/check-auth');
          if (!response.ok) return false;

          const data = await response.json();
          return data.authenticated;
        } catch (error) {
          console.error('Auth check failed:', error);
          return false;
        }
      }

      async function logout() {
        if (!confirm('Are you sure you want to logout?')) return;

        try {
          const res = await fetch('/api/logout');

          if (!res.ok) {
            throw new Error('Logout failed');
          }

          // Remove username from localStorage
          localStorage.removeItem('username');

          window.location.href = '/login';

        } catch (error) {
          console.error('Logout error:', error);
          showToast('Logout failed. Please try again.', 'error');
        }
      }

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        
      }

      function openImportModal() {
        document.getElementById('importModal').style.display = 'flex';
      }

      function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
        document.getElementById('excelData').value = '';
      }

      async function processImportedData() {
        const rawData = document.getElementById('excelData').value;
        if (!rawData.trim()) {
          return showToast('Paste data into the text area first.', 'error');
        }
        try {
          showLoading(true);
          const testCases = parseExcelDataWithMultiline(rawData);
          if (testCases.length === 0) {
            throw new Error('No valid test cases found in the pasted data.');
          }
          await importTestCases(testCases);
          closeImportModal();
          await Promise.all([fetchTests(), fetchFolders()]); // Refresh everything
        } catch (error) {
          showToast(error.message, 'error');
        } finally {
          showLoading(false);
        }
      }

      /**
       * Takes an array of parsed test case objects and sends them to the backend.
       */
      // REPLACE your existing importTestCases function with this one.

      async function importTestCases(testCases) {
        let successCount = 0;
        let failureCount = 0;

        try {
          // --- Step 1: Pre-process and create all necessary folders ---
          const uniqueModules = [...new Set(testCases.map(t => t.module).filter(Boolean))];
          const existingFolderNames = new Set(allFolders.map(f => f.name.toLowerCase()));

          for (const moduleName of uniqueModules) {
            if (!existingFolderNames.has(moduleName.toLowerCase())) {
              // If folder doesn't exist, create it now
              console.log(`Creating new module: ${moduleName}`);
              const res = await fetch('/api/folders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: moduleName, parentId: null })
              });
              if (!res.ok) {
                throw new Error(`Failed to create new module: ${moduleName}`);
              }
            }
          }

          // --- Step 2: Refresh the local folder list to get all new IDs ---
          await fetchFolders();

          console.log("testCases" + JSON.stringify(testCases));


          // --- Step 3: Now, import all test cases with guaranteed valid folder IDs ---
          for (const test of testCases) {
            // Find the folder ID from our now-updated local list. This is much safer.
            const folder = allFolders.find(f => f.name.toLowerCase() === test.module?.toLowerCase());

            if (!folder) {
              console.error(`Module "${test.module}" not found for test case: "${test.title}". Skipping.`);
              failureCount++;
              continue; // Skip to the next test case
            }

            const payload = {
              title: test.title,
              ticketId: test.ticketid || null,
              folderId: folder.id,
              tags: test.tags || null,
              preConditions: test.preconditions || '',
              steps: test.steps || '',
              testData: test.testdata || '',
              expected: test.expectedbehaviour || '',
              actualOutput: test.actualoutput || '',
              status: test.status || 'Not Run',
              createdBy: username
            };

            const response = await fetch('/api/tests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              successCount++;
            } else {
              failureCount++;
            }
          }
        } catch (err) {
          console.error('An error occurred during the import process:', err);
          showToast(err.message, 'error');
          return; // Exit the function on critical errors like folder creation failure
        }

        showToast(`Import complete: ${successCount} succeeded, ${failureCount} failed.`, 'success');
      }
      
    
      /**
 * The definitive function to parse raw text pasted from Excel.
 * This version correctly handles quoted multi-line content inside cells.
 */
function parseExcelDataWithMultiline(data) {
    const rows = [];
    let currentRow = [];
    let currentCell = '';
    let inQuotes = false;
    
    // Normalize line endings to \n
    const text = data.trim().replace(/\r\n/g, '\n');

    // 1. Manually parse the TSV data character by character
    // This is the only reliable way to handle newlines inside quoted cells.
    for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '"') {
            // Toggle the inQuotes state. We assume quotes are not escaped.
            inQuotes = !inQuotes;
        } else if (char === '\t' && !inQuotes) {
            // A tab outside of quotes ends a cell.
            currentRow.push(currentCell.trim());
            currentCell = '';
        } else if (char === '\n' && !inQuotes) {
            // A newline outside of quotes ends a row.
            currentRow.push(currentCell.trim());
            rows.push(currentRow);
            currentCell = '';
            currentRow = [];
        } else {
            // Append the character to the current cell.
            currentCell += char;
        }
    }
    // Add the very last cell and row
    currentRow.push(currentCell.trim());
    if (currentRow.length > 0) {
        rows.push(currentRow);
    }
    
    if (rows.length < 2) {
        return []; // Must have a header and at least one data row
    }

    // 2. Convert the 2D array into an array of objects
    const headers = rows.shift().map(h => h.trim().toLowerCase().replace(/-/g, '').replace(/ /g, ''));
    const titleIndex = headers.indexOf('title');

    if (titleIndex === -1) {
        throw new Error('Import data must include a "Title" column.');
    }

    const result = [];
    rows.forEach(rowValues => {
        // Only create an object if the row has a title
        if (rowValues[titleIndex] && rowValues[titleIndex].trim()) {
            const testCase = {};
            headers.forEach((header, index) => {
                testCase[header] = rowValues[index] || '';
            });
            result.push(testCase);
        }
    });

    return result;
}


      function autoShowColumnsWithData(testsToShow) {
        const autoShowConfig = [
          { dataKey: 'ticketId', value: 'ticketId' },
          { dataKey: 'tags', value: 'tags' },
          { dataKey: 'preConditions', value: 'preConditions' },
          { dataKey: 'steps', value: 'steps' },
          { dataKey: 'testData', value: 'testData' },
          { dataKey: 'expected', value: 'expected' },         // Added this
          { dataKey: 'actualOutput', value: 'actualOutput' },
          { dataKey: 'folder', value: 'folder' }              // Added this
        ];

        autoShowConfig.forEach(col => {
          const header = document.querySelector(`.column-${col.value}`);
          const checkbox = document.querySelector(`#columnVisibilityMenu input[value="${col.value}"]`);

          if (!header || !checkbox) return;

          if (header.classList.contains('hidden-column')) {
            // Check if any test on the page has data for this key.
            const hasData = testsToShow.some(test => {
              const value = test[col.dataKey];
              if (col.dataKey === 'folder') return !!value; // For module/folder, just check if it exists
              return value && String(value).trim() && String(value).trim() !== '<p><br></p>';
            });

            // If data exists, show the column and check the box
            if (hasData) {
              document.querySelectorAll(`.column-${col.value}`).forEach(el => {
                el.classList.remove('hidden-column');
              });
              checkbox.checked = true;
            }
          }
        });
      }

      // Add these THREE new functions anywhere inside your <script> tag

function openBulkEditModal() {
    const form = document.getElementById('bulkEditForm');
    form.reset(); // Clear previous selections

    // Populate the folder dropdown
    const bulkFolderDropdown = document.getElementById('bulkEditFolder');
    bulkFolderDropdown.innerHTML = ''; // Clear old options
    allFolders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        bulkFolderDropdown.appendChild(option);
    });

    // Disable all inputs initially
    form.querySelectorAll('select, input[type="text"]').forEach(input => input.disabled = true);

    document.getElementById('bulkEditModal').style.display = 'flex';
}

async function handleBulkEdit(event) {
    event.preventDefault();
    
    const updates = {};
    const testIds = Array.from(selectedTests);

    // Collect data only from the checked and enabled fields
    document.querySelectorAll('.bulk-edit-toggle:checked').forEach(checkbox => {
        const fieldName = checkbox.id.split('_')[1]; // e.g., "folderId"
        const inputElement = document.getElementById(`bulkEdit${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);
        if(inputElement) {
            updates[fieldName] = inputElement.value;
        }
    });

    if (Object.keys(updates).length === 0) {
        return showToast('Please select at least one field to update.', 'error');
    }

    try {
        showLoading(true);
        const response = await fetch('/api/tests/batch', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ testIds, updates })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error);
        
        document.getElementById('bulkEditModal').style.display = 'none';
        showToast(`${result.affectedRows} test case(s) updated successfully!`, 'success');
        await fetchTests(); // Refresh the table
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}


// --- REQUIRED UPDATES TO EXISTING FUNCTIONS ---

// 1. Update this function to enable/disable the new button
function updateSelectedButtons() {
    const hasSelection = selectedTests.size > 0;
    copySelectedBtn.disabled = !hasSelection;
    deleteSelectedBtn.disabled = !hasSelection;
    document.getElementById('bulkEditBtn').disabled = !hasSelection; // Add this line
}

    </script>
</body>

</html>